const fs = require('fs')
const path = require('path')
const klawSync = require('klaw-sync')
const sizeOf = require('image-size')

const root = path.resolve(__dirname, '../src/images')

// [top, left]
const sizeMapper = {
  'apple imac retina': [],
  'apple imac': [],
  'apple-macbook': [128, 380],
  'macbook air 11': [103, 299],
  'macbook air 13': [103, 262],
  'macbook pro 13': [136, 427],
  'macbook pro 15': [180, 452],
  'xps 13': [86, 317],
  'xps 15': [130, 677],
  'surface book': [187, 574],

  'apple thunderbolt': [129, 114],
  'ultrasharp 5k monitor 27" 90deg': [194, 281],
  'ultrasharp 5k monitor 27"': [178, 167],
  'ultrasharp 24" 90deg': [44, 76],
  'ultrasharp 24"': [27, 27],
  'ultrasharp 27" 90deg': [44, 89],
  'ultrasharp 27"': [59, 33],
  'sony w850c': [22, 12],

  'iphone 5c': [239, 67],
  'iphone 5s': [238, 64],
  'iphone (6s|7)': [300, 120],
  'iphone 6s plus': [379, 102],
  'iphone 7 plus': [600, 300],
  'iphone (8|se)': [280, 100],
  'iphone 8 plus': [400, 200],
  'iphone x': [180, 140],
  'google pixel 2 xl': [340, 200],
  'google pixel 2': [340, 100],
  'google pixel': [500, 200],
  'htc one a9': [293, 85],
  'htc one m8': [267, 72],
  'huawei p8': [320, 100],
  'lumia 950': [366, 93],
  'moto e': [185, 55],
  'moto g': [250, 100],
  'nexus 4': [185, 41],
  'nexus 5x': [231, 53],
  'nexus 6p': [329, 59],
  'nokia 220': [96, 40],
  'nokia 230': [67, 28],
  'nokia asha 230': [101, 39],
  'nokia c3-00': [106, 30],
  'galaxy grand prime': [200, 80],
  'galaxy note 5': [290, 66],
  'galaxy s duos': [156, 48],
  'galaxy s3': [200, 100],
  'galaxy s5': [300, 120],
  'galaxy s7': [400, 140],
  'galaxy s8': [320, 100],
  'galaxy y': [116, 37],

  'ipad air 2': [280, 160],
  'ipad mini 4': [320, 200],
  'ipad pro': [350, 200],
  'surface pro 3': [200, 200],
  'surface pro 4': [200, 240],
  'nexus 9': [300, 180],

  'apple watch 38.*closed$': [228, 100],
  'apple watch 38.*open$': [1600, 100],
  'apple watch 42.*closed$': [300, 100],
  'apple watch 42.*open$': [1770, 110],
  'moto 360.*closed': [139, 44],
  'moto 360.*open': [807, 44],
  'sony smartwatch 3.*closed': [1102, 64],
  'sony smartwatch 3.*open': [188, 64],
}

const data = fs.readdirSync(root).map(kind => {
  return {
    value: kind,
    label: kind,
    children: klawSync(path.resolve(root, kind), {
      nodir: true,
    }).map(file => {
      const image =
        './' + path.relative(path.resolve(__dirname, '../src'), file.path)

      let value = path.basename(file.path, '.png')
      const parentDir = path.basename(path.dirname(file.path))
      if (parentDir.toLowerCase().includes('with shadow')) {
        value += ' with shadow'
      }
      if (value.includes('Snony')) {
        // This is a typo of image file name
        // We don't change image files names, just correct value here for future update
        value = value.replace('Snony', 'Sony')
      }
      value = value.trim() // Remove trailing space

      const { width, height } = sizeOf(file.path)
      let top = 0
      let left = 0

      for (const key in sizeMapper) {
        const reg = new RegExp(key)
        if (reg.test(value.toLowerCase())) {
          ;[top, left] = sizeMapper[key]
          break
        }
      }

      return {
        image,
        value,
        label: value,
        width,
        height,
        top,
        left,
      }
    }),
  }
})

let code = '// Generated by scripts/get-device-tree.js\n'
code += 'export const devices = ' + JSON.stringify(data, null, 2)
code = code.replace(/"image": "(.*?)",/g, '"image": require("$1"),')

fs.writeFileSync(path.resolve(__dirname, '../src/devices.js'), code)
